{%- doc -%}
  Quick filter block for blog pages.
  Renders filter buttons based on article metafield "custom.blog_category".
  Hides itself if there are 0 or 1 unique categories.
{%- enddoc -%}

{% liquid
  assign unique_filters = ''
  assign article_filter_map = ''
  assign filter_count = 0
  assign article_index = 0

  for article in blog.articles
    assign blog_category = article.metafields.custom.blog_category | strip

    # Build article index -> filter map entry (using index since blog-post-item has no data-article-id)
    if article_filter_map != ''
      assign article_filter_map = article_filter_map | append: ','
    endif
    if blog_category != blank
      assign map_entry = '"' | append: article_index | append: '":"' | append: blog_category | append: '"'
    else
      assign map_entry = '"' | append: article_index | append: '":""'
    endif
    assign article_filter_map = article_filter_map | append: map_entry

    if blog_category != blank
      # Track unique filters
      assign filter_exists = false
      assign filters_array = unique_filters | split: '|||'

      for existing_filter in filters_array
        if existing_filter == blog_category
          assign filter_exists = true
          break
        endif
      endfor

      unless filter_exists
        if unique_filters != ''
          assign unique_filters = unique_filters | append: '|||'
        endif
        assign unique_filters = unique_filters | append: blog_category
        assign filter_count = filter_count | plus: 1
      endunless
    endif

    assign article_index = article_index | plus: 1
  endfor

  assign filters_array = unique_filters | split: '|||'
%}

{% if filter_count > 1 %}
  <script src="{{ 'quick-filter-blog.js' | asset_url }}" defer></script>

  <div
    class="quick-filter-blog"
    {{ block.shopify_attributes }}
    style="
      --quick-filter-gap: {{ block.settings.button_gap }}px;
    "
  >
    <div class="quick-filter-blog__buttons" role="tablist" aria-label="Blog category filter">
      <button
        type="button"
        class="quick-filter-blog__button quick-filter-blog__button--active"
        data-filter="all"
        aria-pressed="true"
      >
        {{ block.settings.all_button_label | default: 'All' }}
      </button>

      {% for filter in filters_array %}
        <button
          type="button"
          class="quick-filter-blog__button"
          data-filter="{{ filter | escape }}"
          aria-pressed="false"
        >
          {{ filter }}
        </button>
      {% endfor %}
    </div>

    <script type="application/json" id="quick-filter-blog-map">
      { {{ article_filter_map }} }
    </script>
  </div>
{% endif %}

{% stylesheet %}
  .quick-filter-blog {
    width: 100%;
    overflow: visible;
  }

  .quick-filter-blog__buttons {
    display: flex;
    flex-wrap: nowrap;
    z-index: 99;
    width: 100vw;
    overflow-x: scroll;
    overflow-y: hidden;
    font-size: 13px;
    gap: 10px;
    padding-bottom: 15px;
    box-sizing: border-box;
    scrollbar-width: thin;
    scrollbar-color: rgba(244, 244, 244, .541) transparent;
  }

  .quick-filter-blog__button {
    appearance: none;
    background: rgba(187, 187, 187, 0.25);
    border: 1px solid #f9f9f9;
    padding: var(--padding-sm) var(--padding-md);
    font-family: inherit;
    font-size: var(--font-size-sm);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    cursor: pointer;
    transition: background-color 0.2s ease, color 0.2s ease;
    color: #ffffff;
    flex: 0 0 auto;
    white-space: nowrap;
  }

  .quick-filter-blog__button:hover {
    background: rgba(187, 187, 187, 0.5);
  }

  .quick-filter-blog__button--active {
    background: var(--color-foreground, #000);
    color: var(--color-background, #fff);
  }

  .quick-filter-blog__button--active:hover {
    background: var(--color-foreground, #000);
  }

  /* Hide filtered blog posts */
  .blog-post-item.quick-filter-blog-hidden {
    display: none;
  }
{% endstylesheet %}

{% schema %}
{
  "name": "Quick Filter Blog",
  "tag": "div",
  "class": "quick-filter-blog-block",
  "settings": [
    {
      "type": "text",
      "id": "all_button_label",
      "label": "\"All\" button label",
      "default": "All"
    },
    {
      "type": "range",
      "id": "button_gap",
      "label": "Button gap",
      "min": 0,
      "max": 32,
      "step": 2,
      "unit": "px",
      "default": 8
    }
  ],
  "presets": [
    {
      "name": "Quick Filter Blog"
    }
  ]
}
{% endschema %}
