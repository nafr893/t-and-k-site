<script
  src="{{ 'dialog.js' | asset_url }}"
  type="module"
></script>

<script
  src="{{ 'predictive-search.js' | asset_url }}"
  type="module"
  fetchpriority="low"
></script>

<dialog-component
  id="search-modal"
  class="search-modal"
  {{ block.shopify_attributes }}
>
  <dialog
    ref="dialog"
    on:click="/closeDialogOnClickOutside"
    on:keydown="/closeDialogOnEscapePress"
    class="search-drawer__dialog dialog-modal dialog-drawer"
    scroll-lock
    aria-labelledby="search-drawer-heading"
  >
    <predictive-search-component
      class="predictive-search color-{{ settings.popover_color_scheme }}"
      style="--product-corner-radius: {{ settings.product_corner_radius | default: 8 | append: 'px' }}; --card-corner-radius: {{ settings.card_corner_radius | default: 8 | append: 'px' }};{% if settings.card_title_case == 'uppercase' %} --title-case: uppercase;{% endif %}"
      data-section-id="predictive-search"
      data-testid="{{ 'search-component--modal' }}"
      role="search"
      aria-label="{{ 'content.search_input_label' | t }}"
    >
      <form
        action="{{ routes.search_url }}"
        method="get"
        role="search"
        class="predictive-search-form search-drawer__form"
        ref="form"
        on:keydown="/onSearchKeyDown"
      >
        <div class="search-drawer__header">
          <h2 class="search-drawer__heading" id="search-drawer-heading">
            {{ 'content.search' | t }}
          </h2>
          <button
            type="button"
            class="button-unstyled search-drawer__close-button"
            aria-label="{{ 'accessibility.close_dialog' | t }}"
            on:click="dialog-component/closeDialog"
          >
            <span class="svg-wrapper">
              {{ 'icon-close.svg' | inline_asset_content }}
            </span>
          </button>
        </div>

        <div class="predictive-search-form__header search-drawer__search-bar">
          <div class="predictive-search-form__header-inner">
            <label
              for="search-drawer-input"
              class="visually-hidden"
            >
              {{- 'content.search_input_label' | t -}}
            </label>
            <input
              class="search-input"
              id="search-drawer-input"
              type="search"
              name="q"
              role="combobox"
              aria-expanded="false"
              aria-owns="predictive-search-results"
              aria-controls="predictive-search-results"
              aria-haspopup="listbox"
              aria-autocomplete="list"
              autocomplete="off"
              placeholder="{{ 'content.search_input_placeholder' | t }}"
              ref="searchInput"
              on:input="/search"
              on:keydown="/onSearchKeyDown"
            >
            <input
              name="options[prefix]"
              type="hidden"
              value="last"
            >
            <span class="svg-wrapper predictive-search__icon">
              {{ 'icon-search.svg' | inline_asset_content }}
            </span>
            <button
              type="button"
              class="button-unstyled predictive-search__reset-button"
              ref="resetButton"
              hidden
              on:click="/resetSearch"
            >
              {{ 'actions.clear' | t }}
            </button>
          </div>
        </div>

        <div class="predictive-search-form__content-wrapper search-drawer__content-wrapper">
          <div
            class="predictive-search-form__content"
            tabindex="-1"
            ref="predictiveSearchResults"
            on:click="/handleModalClick"
          >
            {% render 'predictive-search-empty-state',
              load_empty_state: true,
              shadow_opacity: 0.1,
              products_test_id: 'products-list-default--modal'
            %}
          </div>

          <div class="predictive-search-form__footer search-drawer__footer">
            <button
              class="button button-primary predictive-search__search-button"
              ref="viewAllButton"
            >
              {{ 'content.search_results_view_all' | t }}
            </button>
          </div>
        </div>
      </form>
    </predictive-search-component>
  </dialog>
</dialog-component>

{% stylesheet %}
  /* ============================================
     Search Modal Base
  ============================================ */
  .search-modal {
    --search-border-radius: var(--style-border-radius-popover);
    --search-border-width: var(--style-border-width);
  }

  .search-modal__button {
    display: flex;
    align-items: center;
    justify-content: center;
  }

  /* ============================================
     Search Drawer — Dialog Positioning
  ============================================ */
  .search-drawer__dialog {
    position: fixed;
    overflow: hidden;
    border-radius: 0;
    width: var(--sidebar-width);
    max-width: 100vw;
    height: 100%;
    margin: 0 0 0 auto;
    padding: 0;
    border: none;
    border-left: var(--style-border-drawer);
    box-shadow: var(--shadow-drawer);
    background-color: var(--color-background);

    @media screen and (max-width: 749px) {
      width: 100%;
    }
  }

  .search-drawer__dialog:modal {
    max-height: 100dvh;
    overflow-y: hidden;
  }

  /* Override dialog-modal open animation — use drawer slide-from-right */
  .dialog-modal[open].search-drawer__dialog {
    transform-origin: initial;
    --start-x: 100%;
    --end-x: 0px;
    --start-opacity: 1;
    animation: move-and-fade var(--animation-speed) var(--animation-easing) forwards;
  }

  /* Override dialog-modal closing animation */
  .dialog-modal.search-drawer__dialog.dialog-closing {
    --start-x: 0px;
    --end-x: 100%;
    --start-opacity: 1;
    --end-opacity: 1;
    animation: move-and-fade var(--animation-speed) var(--animation-easing) forwards;
  }

  /* ============================================
     Search Drawer — Layout (flex column, fills dialog)
  ============================================ */
  .search-drawer__dialog predictive-search-component {
    height: 100%;
    flex-direction: column;
    overflow: hidden;
  }

  .search-drawer__dialog .search-drawer__form {
    height: 100%;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    align-self: stretch;
    width: 100%;
  }

  /* ============================================
     Search Drawer — Header (title + close button)
  ============================================ */
  .search-drawer__header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--padding-xl) var(--padding-2xl);
    background-color: var(--color-background);
    flex-shrink: 0;

    @media screen and (max-width: 749px) {
      padding: var(--padding-lg) var(--padding-xl);
    }
  }

  .search-drawer__heading {
    font-size: var(--font-h4--size);
    font-weight: var(--font-heading--weight);
    margin: 0;
    color: var(--color-foreground);
  }

  .search-drawer__close-button {
    --button-color: var(--color-foreground);

    display: flex;
    align-items: center;
    justify-content: center;
    width: var(--minimum-touch-target);
    height: var(--minimum-touch-target);
    padding: 0;
    background: transparent;
    cursor: pointer;
    color: var(--color-foreground);

    .svg-wrapper,
    svg {
      width: var(--icon-size-xs);
      height: var(--icon-size-xs);
    }

    &:active {
      transform: scale(0.8);
      transition: transform 100ms var(--animation-timing-active);
    }
  }

  /* ============================================
     Search Drawer — Search Bar (static, not sticky)
     Use .search-drawer__dialog.dialog-modal for [0,3,0] specificity
     to beat .dialog-modal .predictive-search-form__header [0,2,0]
  ============================================ */
  .search-drawer__dialog.dialog-modal .predictive-search-form__header {
    position: static;
    flex-shrink: 0;
    border-radius: 0;
    border: none;
    border-bottom: var(--style-border-width) solid var(--color-border);
    background-color: var(--color-background);
    padding: var(--padding-sm) var(--padding-xl);
    box-shadow: none;
    transition: none;
    padding-bottom: var(--padding-md);

    @media screen and (min-width: 750px) {
      padding: var(--padding-xs) var(--padding-xl);
      border-bottom: var(--style-border-width) solid var(--color-border);
          padding-bottom: var(--padding-md);

    }

    @media screen and (max-width: 749px) {
      transition: none;
      box-shadow: none;
    }
  }

  .search-drawer__dialog.dialog-modal .predictive-search-form__header:has(.predictive-search-form__header-inner:focus-within) {
    @media screen and (min-width: 750px) {
      border-bottom-color: var(--color-border);
    }
  }

  .search-drawer__dialog.dialog-modal .predictive-search-form__header-inner {
    border: var(--style-border-width) solid var(--color-border);
    border-radius: var(--style-border-radius-inputs);

    @media screen and (min-width: 750px) {
      border: var(--style-border-width) solid var(--color-border);
    }
  }

  /* ============================================
     Search Drawer — Content Wrapper (fills remaining height)
  ============================================ */
  .search-drawer__dialog .predictive-search-form__content-wrapper {
    position: static;
    flex: 1;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    max-height: none;
    border-radius: 0;
    box-shadow: none;
    transform: none;
    transition: none;
    will-change: auto;
    top: auto;
    left: auto;
    z-index: auto;
  }

  /* ============================================
     Search Drawer — Scrollable Content Area
  ============================================ */
  .search-drawer__dialog .predictive-search-form__content {
    flex: 1;
    overflow-y: auto;
    max-height: none;
    background-color: var(--color-background);
    scrollbar-width: none;
    padding-block-end: 0;

    &::-webkit-scrollbar {
      display: none;
    }
  }

  /* Remove bottom padding for view-all button since footer is now static */
  .search-drawer__dialog .predictive-search-form__content-wrapper:has([data-search-results]):not(:has(.predictive-search-results__no-results))
    > .predictive-search-form__content {
    padding-block-end: 0;
  }

  /* ============================================
     Search Drawer — Footer (View All Results)
  ============================================ */
  .search-drawer__dialog .predictive-search-form__footer {
    position: static;
    flex-shrink: 0;
    padding: var(--padding-lg) var(--padding-2xl);
    background-color: var(--color-background);
    background-image: none;
    border-top: var(--style-border-width) solid var(--color-border);
  }

  .search-drawer__dialog .predictive-search__search-button {
    width: 100%;
    margin: 0;
  }

  /* ============================================
     Predictive Search — Shared UI Styles
     (kept from original search-modal.liquid)
  ============================================ */
  predictive-search-component {
    --resource-card-corner-radius: var(--product-corner-radius);

    display: flex;
    width: 100%;
    position: relative;
    margin-inline: auto;
    align-items: center;
    background-color: var(--color-background);
    z-index: var(--layer-heightened);
  }

  .predictive-search-form__footer {
    display: none;
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;

    @media screen and (min-width: 750px) {
      --to-top-gradient-background: linear-gradient(
        to top,
        rgb(var(--color-background-rgb) / var(--opacity-90)),
        rgb(var(--color-background-rgb) / var(--opacity-80)),
        rgb(var(--color-background-rgb) / var(--opacity-40)),
        transparent
      );

      padding-block: var(--padding-xs) var(--padding-lg);
      background-image: var(--to-top-gradient-background);
    }
  }

  predictive-search-component:has([data-search-results]):not(:has(.predictive-search-results__no-results))
    .predictive-search-form__footer {
    display: block;
  }

  .predictive-search-form {
    position: relative;
    width: 100%;
    align-self: flex-start;
  }

  .predictive-search-form__content {
    max-height: 50dvh;
    overflow-y: auto;
    background-color: var(--color-background);

    /* Firefox */
    scrollbar-width: none;

    /* Webkit browsers */
    &::-webkit-scrollbar {
      display: none;
    }
  }

  .predictive-search-form__content-wrapper {
    position: absolute;
    top: 100%;
    width: 100%;
    left: 0;
    z-index: var(--layer-raised);
    display: flex;
    flex-direction: column;
    border-radius: 0 0 var(--search-border-radius) var(--search-border-radius);
    transition: box-shadow var(--animation-speed) var(--animation-easing);
    transform: translateZ(0);
    will-change: transform, opacity;
    overflow: hidden;

    @media screen and (max-width: 749px) {
      border-radius: 0;
    }

    @media screen and (min-width: 750px) {
      max-height: var(--modal-max-height);
    }
  }

  .predictive-search-form__content-wrapper:has([data-search-results]):not(:has(.predictive-search-results__no-results))
    > .predictive-search-form__content {
    padding-block-end: var(--padding-6xl);
  }

  .predictive-search-form__header-inner {
    background: var(--color-background);
    border: var(--search-border-width) solid var(--color-border);
    color: var(--color-foreground);
    border-radius: var(--style-border-radius-popover);
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;

    @media screen and (max-width: 749px) {
      border-radius: var(--style-border-radius-inputs);
      border: none;
    }
  }

  .predictive-search-form__header-inner:focus-within {
    outline-offset: var(--focus-outline-offset);

    @media screen and (min-width: 750px) {
      outline: var(--focus-outline-width) solid var(--color-primary);
    }
  }

  .predictive-search-form__header {
    display: flex;
    position: sticky;
    top: 0;
    z-index: var(--layer-heightened);
    width: 100%;
    align-items: center;
    background-color: var(--color-input-background);
    border: var(--search-border-width) solid var(--color-border);
    border-radius: var(--style-border-radius-inputs);

    @media screen and (max-width: 749px) {
      padding: var(--padding-2xs) var(--padding-sm);
    }
  }

  .predictive-search-form__header:focus-within,
  .predictive-search-form__header-inner:focus-within,
  .predictive-search-form__header-inner:has(.search-input:is(:focus, :focus-visible)) {
    outline: none;
    box-shadow: none;
    /* stylelint-disable-next-line declaration-no-important */
    border-color: var(--color-border) !important;
  }

  .predictive-search-results__inner {
    --title-font-size: var(--font-size--md);
    --title-margin-block: var(--margin-xs);
    --list-item-padding-block: var(--padding-sm);

    flex-grow: 1;
    overflow-y: auto;
    padding-block: var(--padding-lg);
    container-type: inline-size;
    color: var(--color-foreground);
  }

  /* Empty state has its own section spacing — remove outer padding */
  .search-drawer__empty-state.predictive-search-results__inner {
    padding-block: 0;
  }

  .search-input {
    border-radius: 0;
    padding-block: var(--padding-sm);
    font-size: var(--font-size--md);
    width: 100%;
    color: #d5d5d5;
    padding-inline: calc(var(--margin-sm) + var(--icon-size-sm)) 0;
    background: transparent;
    text-overflow: ellipsis;
    overflow: hidden;
    outline: none;
    border: 0;
  }

  .search-input::placeholder {
    color: rgb(var(--color-foreground-rgb) / var(--opacity-subdued-text));
  }

  .search-input,
  .search-input:is(:focus, :focus-visible, :focus-within),
  .predictive-search-form__header *:is(:focus, :focus-visible) {
    outline: none;
    box-shadow: none;
  }

  .search-input:hover {
    background-color: transparent;
  }

  .predictive-search__icon {
    position: absolute;
    left: 1.5rem;
    top: auto;
    width: var(--icon-size-lg);
    height: var(--icon-size-lg);
    color: rgb(var(--color-foreground-rgb) / var(--opacity-60));

    @media screen and (min-width: 750px) {
      left: 1.5rem;
    }
  }

  .predictive-search__icon > svg {
    width: var(--icon-size-md);
    height: var(--icon-size-md);
  }

  .predictive-search__reset-button {
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: var(--minimum-touch-target);
    height: var(--minimum-touch-target);
    padding: 0;
    margin-inline-end: var(--margin-md);
    background: transparent;
    color: var(--color-foreground);
    opacity: 0.68;
    transition: opacity var(--animation-speed-medium) var(--animation-timing-fade-out),
      visibility var(--animation-speed-medium) var(--animation-timing-fade-out);

    &:hover {
      color: var(--color-foreground);
    }

    &:active {
      transform: scale(0.9);
      transition: transform 100ms var(--animation-timing-active);
    }

    @media screen and (min-width: 750px) {
      margin-inline-end: var(--margin-2xs);
    }
  }

  .predictive-search__reset-button[hidden] {
    opacity: 0;
    pointer-events: none;
    visibility: hidden;
  }

  .predictive-search__reset-button-icon {
    display: flex;
    align-items: center;
    justify-content: center;
    width: var(--icon-size-lg);
    height: var(--icon-size-lg);
    transition: background-color var(--animation-speed-medium) ease-in-out,
      transform var(--animation-speed-medium) var(--animation-timing-bounce);
    border-radius: 50%;

    &:hover {
      background-color: rgb(var(--color-primary-hover-rgb) / var(--opacity-8));
    }
  }

  .predictive-search__reset-button:active .predictive-search__reset-button-icon {
    transform: scale(0.85);
    transition-timing-function: var(--animation-timing-active);
    transition-duration: 100ms;
  }

  .predictive-search__reset-button svg {
    width: var(--icon-size-md);
    height: var(--icon-size-md);
  }

  .predictive-search__reset-button-text {
    display: none;
  }

  .predictive-search__search-button {
    margin: auto;
    z-index: var(--layer-raised);
    transition: transform var(--animation-speed-medium) var(--animation-timing-bounce),
      box-shadow var(--animation-speed-medium) var(--animation-timing-hover);
    transform-origin: center;

    &:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgb(0 0 0 / var(--opacity-5));
    }

    &:active {
      transform: scale(0.97);
      transition: transform 100ms var(--animation-timing-active);
      box-shadow: none;
    }
  }

  /* Drawer reset-button text label on all screen sizes */
  .search-drawer__dialog .predictive-search__reset-button-icon {
    display: none;
  }

  .search-drawer__dialog .predictive-search__reset-button-text {
    display: block;
  }

  @keyframes search-element-slide-in-bottom {
    from {
      transform: translateY(20px);
      opacity: 0;
    }

    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  @keyframes search-element-slide-out-bottom {
    from {
      transform: translateY(0);
      opacity: 1;
    }

    to {
      transform: translateY(20px);
      opacity: 0;
    }
  }

  @keyframes search-element-slide-in-top {
    from {
      margin-top: calc(var(--modal-top-margin) + var(--padding-sm));
      opacity: 0;
    }

    to {
      margin-top: var(--modal-top-margin);
      opacity: 1;
    }
  }

  @keyframes search-element-slide-out-top {
    from {
      margin-top: var(--modal-top-margin);
      opacity: 1;
    }

    to {
      margin-top: calc(var(--modal-top-margin) + var(--padding-sm));
      opacity: 0;
    }
  }

  @keyframes content-slide {
    from {
      transform: translateY(var(--slide-from, 0));
      opacity: var(--slide-opacity-from, 1);
    }

    to {
      transform: translateY(var(--slide-to, 0));
      opacity: var(--slide-opacity-to, 1);
    }
  }
{% endstylesheet %}
