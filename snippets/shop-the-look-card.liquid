{%- doc -%}
  Renders a product card for Shop the Look section.

  @param {object} product - The product object
  @param {string} position - Card position ('left' or 'right')
  @param {string} color_scheme - Color scheme for the card
  @param {string} section_id - Parent section ID
  @param {object} block - Block object for shopify_attributes
{%- enddoc -%}

{% liquid
  assign variant = product.selected_or_first_available_variant
  assign has_rating = false
  if product.metafields.reviews.rating.value.rating != blank
    assign has_rating = true
  endif

  # Check for color swatches
  assign has_swatches = false
  for product_option in product.options_with_values
    assign swatch_count = product_option.values | map: 'swatch' | compact | size
    if swatch_count > 0
      assign has_swatches = true
      break
    endif
  endfor
%}

<div class="stl-card color-{{ color_scheme | default: 'scheme-1' }}">
  {%- comment -%} Product Image with Badge {%- endcomment -%}
  <div class="stl-card__media">
    <a href="{{ product.url }}" class="stl-card__image-link">
      {% if product.featured_image != blank %}
        {% render 'image', image: product.featured_image, class: 'stl-card__image', height: 280 %}
      {% else %}
        {{ 'product-apparel-1' | placeholder_svg_tag: 'stl-card__image stl-card__placeholder' }}
      {% endif %}
    </a>

    {%- comment -%} Badge (New/Sale/Sold Out) {%- endcomment -%}
    <div class="stl-card__badges">
      {% if product.available == false %}
        <span class="stl-card__badge stl-card__badge--sold-out">
          Sold out
        </span>
      {% elsif product.compare_at_price > product.price %}
        <span class="stl-card__badge stl-card__badge--sale">
          Sale
        </span>
      {% elsif product.metafields.custom.is_new == true %}
        <span class="stl-card__badge stl-card__badge--new">
          New
        </span>
      {% endif %}
    </div>
  </div>

  {%- comment -%} Product Info {%- endcomment -%}
  <div class="stl-card__content">
    {%- comment -%} Title {%- endcomment -%}
    <h3 class="stl-card__title h5">
      <a href="{{ product.url }}">{{ product.title }}</a>
    </h3>

    {%- comment -%} Price {%- endcomment -%}
    <div class="stl-card__price">
      {% render 'price', product_resource: product %}
    </div>

    {%- comment -%} Star Rating (if available) {%- endcomment -%}
    {% if has_rating %}
      {% liquid
        assign rating = product.metafields.reviews.rating.value.rating | round: 1
        assign scale_max = product.metafields.reviews.rating.value.scale_max | default: 5
        assign rating_count = product.metafields.reviews.rating_count | default: 0
        assign rating_decimal = rating | modulo: 1
      %}
      <div class="stl-card__rating" aria-label="Rating: {{ rating }} out of {{ scale_max }} stars">
        <div class="stl-card__stars">
          {% for i in (1..scale_max) %}
            {% liquid
              assign star_value = i | times: 1.0
              assign is_full = false
              assign is_half = false

              if rating >= star_value
                assign is_full = true
              elsif rating >= star_value | minus: 0.5
                assign is_half = true
              endif
            %}
            <span class="stl-card__star {% if is_full %}stl-card__star--filled{% elsif is_half %}stl-card__star--half{% endif %}">
              <svg viewBox="0 0 20 20" fill="currentColor" width="16" height="16">
                {% if is_half %}
                  <defs>
                    <linearGradient id="half-star-{{ section_id }}-{{ i }}">
                      <stop offset="50%" stop-color="currentColor" />
                      <stop offset="50%" stop-color="transparent" />
                    </linearGradient>
                  </defs>
                  <path fill="url(#half-star-{{ section_id }}-{{ i }})" stroke="currentColor" stroke-width="1" d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                {% else %}
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                {% endif %}
              </svg>
            </span>
          {% endfor %}
        </div>
        {% if rating_count > 0 %}
          <span class="stl-card__rating-count">{{ rating_count }}</span>
        {% endif %}
      </div>
    {% endif %}

    {%- comment -%} Color Swatches {%- endcomment -%}
    {% if has_swatches %}
      <div class="stl-card__swatches">
        {% render 'variant-swatches', product_resource: product %}
      </div>
    {% endif %}

    {%- comment -%} CTA Button {%- endcomment -%}
    <div class="stl-card__cta">
      <a href="{{ product.url }}" class="stl-card__button button button--primary">
        View Product
      </a>
    </div>
  </div>
</div>

{% stylesheet %}
  .stl-card {
    display: flex;
    flex-direction: column;
    background: var(--color-background);
    border-radius: var(--style-border-radius-popover, 8px);
    box-shadow: var(--shadow-popover, 0 4px 24px rgb(0 0 0 / 0.12));
    overflow: hidden;
    width: 100%;
  }

  .stl-card__media {
    position: relative;
    aspect-ratio: 1;
    overflow: hidden;
  }

  .stl-card__image-link {
    display: block;
    width: 100%;
    height: 100%;
  }

  .stl-card__image,
  .stl-card__placeholder {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .stl-card__badges {
    position: absolute;
    top: var(--padding-sm, 12px);
    left: var(--padding-sm, 12px);
    display: flex;
    flex-direction: column;
    gap: var(--gap-2xs, 4px);
  }

  .stl-card__badge {
    display: inline-block;
    padding: var(--padding-2xs, 4px) var(--padding-sm, 12px);
    font-size: var(--font-body--size-sm, 12px);
    font-weight: var(--font-weight-medium, 500);
    text-transform: uppercase;
    letter-spacing: var(--letter-spacing-sm, 0.05em);
    border-radius: var(--border-radius-sm, 4px);
  }

  .stl-card__badge--new {
    background: var(--color-accent, #e74c3c);
    color: #fff;
  }

  .stl-card__badge--sale {
    background: var(--color-accent, #e74c3c);
    color: #fff;
  }

  .stl-card__badge--sold-out {
    background: rgb(var(--color-foreground-rgb) / var(--opacity-10, 0.1));
    color: var(--color-foreground);
  }

  .stl-card__content {
    display: flex;
    flex-direction: column;
    gap: var(--gap-xs, 8px);
    padding: var(--padding-md, 16px);
  }

  .stl-card__title {
    margin: 0;
    font-size: var(--font-heading--size-h5, 16px);
    line-height: var(--line-height-tight, 1.25);
  }

  .stl-card__title a {
    color: inherit;
    text-decoration: none;
  }

  .stl-card__title a:hover {
    text-decoration: underline;
  }

  .stl-card__price {
    font-size: var(--font-body--size, 14px);
    display: flex;
    align-items: center;
    gap: var(--gap-xs, 8px);
    flex-wrap: wrap;
  }

  .stl-card__price .compare-at-price {
    text-decoration: line-through;
    opacity: var(--opacity-60, 0.6);
  }

  .stl-card__rating {
    display: flex;
    align-items: center;
    gap: var(--gap-xs, 8px);
  }

  .stl-card__stars {
    display: flex;
    align-items: center;
    gap: 2px;
  }

  .stl-card__star {
    color: rgb(var(--color-foreground-rgb) / var(--opacity-25, 0.25));
    display: flex;
  }

  .stl-card__star--filled,
  .stl-card__star--half {
    color: #f59e0b;
  }

  .stl-card__rating-count {
    font-size: var(--font-body--size-sm, 12px);
    color: rgb(var(--color-foreground-rgb) / var(--opacity-60, 0.6));
  }

  .stl-card__swatches {
    margin-top: var(--gap-2xs, 4px);
  }

  .stl-card__swatches .variant-option {
    margin: 0;
    padding: 0;
    border: none;
  }

  .stl-card__swatches .variant-option__swatch-value {
    display: none;
  }

  .stl-card__swatches fieldset {
    display: flex;
    flex-wrap: wrap;
    gap: var(--gap-xs, 8px);
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .stl-card__swatches .variant-option__swatch {
    width: 24px;
    height: 24px;
  }

  .stl-card__swatches .variant-option__button-label {
    width: 100%;
    height: 100%;
    border-radius: 50%;
  }

  .stl-card__cta {
    margin-top: var(--gap-xs, 8px);
  }

  .stl-card__button {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    padding: var(--padding-sm, 12px) var(--padding-md, 16px);
    font-size: var(--font-body--size, 14px);
    font-weight: var(--font-weight-medium, 500);
    text-transform: uppercase;
    letter-spacing: var(--letter-spacing-sm, 0.05em);
    text-decoration: none;
    border-radius: var(--border-radius-sm, 4px);
    transition: opacity var(--animation-speed, 0.2s) ease;
  }

  .stl-card__button:hover {
    opacity: var(--opacity-80, 0.8);
  }
{% endstylesheet %}
