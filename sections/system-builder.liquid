{%- comment -%}
  System Builder Section — Harness Configurator

  Metaobject structure:
  - harness_model: Top-level chip buttons (harness_name text field only)
  - harness_type: Products linked to a model (harness_model ref list + harness_product variant list)
  - harness_accessory: Accessory chips filtered by model (accessory_name + harness_type model ref + accessory_product variants)
{%- endcomment -%}

{{ 'system-builder.css' | asset_url | stylesheet_tag }}

{%- liquid
  assign harness_models = shop.metaobjects.harness_model.values
  assign harness_types = shop.metaobjects.harness_type.values
  assign harness_accessories = shop.metaobjects.harness_accessory.values
-%}

<system-builder class="system-builder section-{{ section.id }}" id="system-builder-{{ section.id }}">
  {%- comment -%} Data payloads for JavaScript {%- endcomment -%}

  {%- comment -%} Harness models — chip labels only {%- endcomment -%}
  <script type="application/json" data-harness-models>
    [
      {%- paginate harness_models by 250 -%}
      {%- for model in harness_models -%}
        {
          "id": {{ model.id | json }},
          "handle": {{ model.system.handle | json }},
          "name": {{ model | json }}
        }{%- unless forloop.last -%},{%- endunless -%}
      {%- endfor -%}
      {%- endpaginate -%}
    ]
  </script>

  {%- comment -%} Harness types — products linked to models {%- endcomment -%}
  <script type="application/json" data-harness-types>
    [
      {%- paginate harness_types by 250 -%}
      {%- for ht in harness_types -%}
        {
          "id": {{ ht.id | json }},
          "handle": {{ ht.system.handle | json }},
          "modelHandles": [
            {%- for ref in ht.harness_model.value -%}
              {{ ref.system.handle | json }}{%- unless forloop.last -%},{%- endunless -%}
            {%- endfor -%}
          ],
          "variants": [
            {%- for variant in ht.harness_product.value -%}
              {
                "id": {{ variant.id | json }},
                "title": {{ variant.title | json }},
                "price": {{ variant.price | json }},
                "productTitle": {{ variant.product.title | json }},
                "image": {{ variant.image.src | default: variant.product.featured_image | json }},
                "available": {{ variant.available | json }}
              }{%- unless forloop.last -%},{%- endunless -%}
            {%- endfor -%}
          ]
        }{%- unless forloop.last -%},{%- endunless -%}
      {%- endfor -%}
      {%- endpaginate -%}
    ]
  </script>

  {%- comment -%} Harness accessories — filtered by model {%- endcomment -%}
  <script type="application/json" data-harness-accessories>
    [
      {%- paginate harness_accessories by 250 -%}
      {%- for accessory in harness_accessories -%}
        {
          "id": {{ accessory.id | json }},
          "handle": {{ accessory.system.handle | json }},
          "name": {{ accessory.accessory_name | json }},
          "modelHandles": [
            {%- for ref in accessory.harness_type.value -%}
              {{ ref.system.handle | json }}{%- unless forloop.last -%},{%- endunless -%}
            {%- endfor -%}
          ],
          "variants": [
            {%- for variant in accessory.accessory_product.value -%}
              {
                "id": {{ variant.id | json }},
                "title": {{ variant.title | json }},
                "price": {{ variant.price | json }},
                "productTitle": {{ variant.product.title | json }},
                "image": {{ variant.image.src | default: variant.product.featured_image | json }},
                "available": {{ variant.available | json }}
              }{%- unless forloop.last -%},{%- endunless -%}
            {%- endfor -%}
          ]
        }{%- unless forloop.last -%},{%- endunless -%}
      {%- endfor -%}
      {%- endpaginate -%}
    ]
  </script>

  {%- comment -%} Block accessories data {%- endcomment -%}
  <script type="application/json" data-accessories>
    [
      {%- for block in section.blocks -%}
        {%- if block.type == 'accessory' and block.settings.product -%}
          {%- assign accessory = block.settings.product -%}
          {%- assign accessory_variant = accessory.selected_or_first_available_variant -%}
          {
            "id": {{ accessory_variant.id | json }},
            "blockId": {{ block.id | json }},
            "title": {{ accessory_variant.title | json }},
            "price": {{ accessory_variant.price | json }},
            "productTitle": {{ accessory.title | json }},
            "image": {{ accessory_variant.image.src | default: accessory.featured_image | json }},
            "available": {{ accessory_variant.available | json }}
          }{%- unless forloop.last -%},{%- endunless -%}
        {%- endif -%}
      {%- endfor -%}
    ]
  </script>

  <div class="system-builder__container container">
    {%- if section.settings.heading != blank -%}
      <h2 class="system-builder__heading h2">{{ section.settings.heading }}</h2>
    {%- endif -%}

    {%- if section.settings.subheading != blank -%}
      <div class="system-builder__subheading rte">{{ section.settings.subheading }}</div>
    {%- endif -%}

    <div class="system-builder__layout">
      {%- comment -%} Left Column: Steps {%- endcomment -%}
      <div class="system-builder__steps">
        {%- comment -%} Harness Models — chip selection then product cards {%- endcomment -%}
        <div class="system-builder__step" data-step="harness-models">
          <h3 class="system-builder__step-title h4">{{ section.settings.harness_models_step_title }}</h3>
          <div class="system-builder__field" data-field="harness-model">
            <div class="system-builder__chips" data-chips="harness-model">
              {%- paginate harness_models by 250 -%}
              {%- for model in harness_models -%}
                {%- capture chip_label -%}{{ model }}{% endcapture %}
                {%- assign chip_label = chip_label | strip -%}
                {%- render 'system-builder-option-chip',
                  value: model.system.handle,
                  label: chip_label,
                  field: 'harness-model'
                -%}
              {%- else -%}
                <p class="system-builder__empty-message">No harness models configured.</p>
              {%- endfor -%}
              {%- endpaginate -%}
            </div>
          </div>
          <div class="system-builder__accessories-grid" data-harness-models-grid>
            {%- comment -%} Product cards populated by JavaScript when a harness type chip is clicked {%- endcomment -%}
          </div>
        </div>

        {%- comment -%} Harness Accessories — chip selection {%- endcomment -%}
        <div class="system-builder__step" data-step="harness-accessories">
          <h3 class="system-builder__step-title h4">{{ section.settings.harness_accessories_step_title }}</h3>
          <div class="system-builder__field" data-field="harness-accessory">
            <div class="system-builder__chips" data-chips="harness-accessory">
              {%- paginate harness_accessories by 250 -%}
              {%- for accessory in harness_accessories -%}
                {%- render 'system-builder-option-chip',
                  value: accessory.system.handle,
                  label: accessory.accessory_name,
                  field: 'harness-accessory'
                -%}
              {%- else -%}
                <p class="system-builder__empty-message">No harness accessories configured.</p>
              {%- endfor -%}
              {%- endpaginate -%}
            </div>
          </div>
          <div class="system-builder__accessories-grid" data-harness-accessories-grid>
            {%- comment -%} Product cards populated by JavaScript when chips are toggled {%- endcomment -%}
          </div>
        </div>

        {%- comment -%} Block Accessories (manual products) {%- endcomment -%}
        {%- if section.blocks.size > 0 -%}
          <div class="system-builder__step system-builder__step--accessories" data-step="accessories">
            <h3 class="system-builder__step-title h4">{{ section.settings.accessories_step_title }}</h3>
            <div class="system-builder__accessories-grid" data-accessories-grid>
              {%- comment -%} Product cards populated by JavaScript {%- endcomment -%}
            </div>
          </div>
        {%- endif -%}
      </div>{%- comment -%} End .system-builder__steps {%- endcomment -%}

      {%- comment -%} Right Column: Summary Sidebar {%- endcomment -%}
      <div class="system-builder__sidebar">
        <div class="system-builder__summary" data-summary>
          <h3 class="system-builder__summary-title h4">{{ section.settings.summary_title | default: 'Your Selection' }}</h3>

          <div class="system-builder__summary-items" data-summary-items>
          </div>

          <div class="system-builder__summary-empty" data-summary-empty>
            <p>Select products to add to your system.</p>
          </div>

          <div class="system-builder__summary-footer" data-summary-footer hidden>
            <div class="system-builder__summary-total">
              <span class="system-builder__summary-total-label">{{ section.settings.total_label | default: 'Total' }}</span>
              <span class="system-builder__summary-total-price" data-total-price></span>
            </div>

            <button type="button" class="system-builder__add-to-cart button button--primary" data-add-to-cart>
              {{ section.settings.add_to_cart_text | default: 'Add All to Cart' }}
            </button>
          </div>
        </div>
      </div>{%- comment -%} End .system-builder__sidebar {%- endcomment -%}
    </div>{%- comment -%} End .system-builder__layout {%- endcomment -%}
  </div>
</system-builder>

<script src="{{ 'system-builder.js' | asset_url }}" defer></script>

{% schema %}
{
  "name": "System Builder",
  "tag": "section",
  "class": "shopify-section--system-builder",
  "settings": [
    {
      "type": "header",
      "content": "General"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Build Your System"
    },
    {
      "type": "richtext",
      "id": "subheading",
      "label": "Subheading"
    },
    {
      "type": "header",
      "content": "Harness Models"
    },
    {
      "type": "text",
      "id": "harness_models_step_title",
      "label": "Step Title",
      "default": "1. Choose Your Harness"
    },
    {
      "type": "header",
      "content": "Harness Accessories"
    },
    {
      "type": "text",
      "id": "harness_accessories_step_title",
      "label": "Step Title",
      "default": "2. Add Accessories"
    },
    {
      "type": "header",
      "content": "Additional Accessories"
    },
    {
      "type": "text",
      "id": "accessories_step_title",
      "label": "Step Title",
      "default": "3. Extras"
    },
    {
      "type": "header",
      "content": "Summary"
    },
    {
      "type": "text",
      "id": "summary_title",
      "label": "Summary Title",
      "default": "Your Selection"
    },
    {
      "type": "text",
      "id": "total_label",
      "label": "Total Label",
      "default": "Total"
    },
    {
      "type": "text",
      "id": "add_to_cart_text",
      "label": "Add to Cart Button Text",
      "default": "Add All to Cart"
    }
  ],
  "blocks": [
    {
      "type": "accessory",
      "name": "Accessory",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Accessory Product"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "System Builder"
    }
  ]
}
{% endschema %}
